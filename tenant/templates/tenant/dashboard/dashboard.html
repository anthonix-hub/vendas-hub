{% extends "tenant/dashboard/dashboard_base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<main class="flex-1 p-4 md:p-6 bg-gray-100 mt-16 md:mt-10"> {# Adjusted padding and background #}
    {# Inventory Alerts (Keep as is) #}
    {% if low_stock_alerts %}
    <section
        id="inventory-alerts"
        class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md shadow-sm relative"
        role="alert"
    >   
        <div class="flex">
            <div class="py-1"><i class="fas fa-exclamation-triangle mr-3"></i></div>
            <div>
                <p class="font-bold">Inventory Alerts</p>
                <ul class="list-disc list-inside text-sm">
                    {% for alert in low_stock_alerts %}
                        <li>{{ alert.name }}: Only {{ alert.stock }} left! stock up.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <button
            onclick="closeInventoryAlerts()"
            class="absolute top-2 right-2 text-yellow-500 hover:text-yellow-700 focus:outline-none"
            aria-label="Close"
        >
            <i class="fas fa-times"></i>
        </button>
    </section>
    {% endif %}
    <h1 class="text-2xl md:text-3xl font-semibold text-gray-800 mb-2">
        {# Total Revenue #}
        <div class="bg-white p-4 md:p-6 rounded-md shadow-sm border-t-2 {% if total_revenue <= 0 %} border-red-500 {% else %} border-green-500 {% endif %} flex items-center space-x-4">
            <div class="bg-red-100 p-3 rounded-full text-center items-center px-6 shadow-lg ">
                <i class="fas fa-dollar-sign text-red-500 text-xl"></i>
            </div>
            <div>
                <h2 class="text-sm font-medium text-gray-500 uppercase">Total Revenue</h2>
                <p class="text-2xl font-semibold text-gray-800">₦{{ total_revenue|default:0|floatformat:2|intcomma }}</p>
            </div>
        </div>
    </h1>

    <!-- Key Metrics Section (Keep as is) -->
    <section class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 mb-6 ">
        {# Total Orders #}
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm border-l-4 border-blue-500 flex items-center space-x-4">
            <div class="bg-blue-100 p-3 rounded-full shadow-lg">
                <i class="fas fa-shopping-cart text-blue-500 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xs font-medium text-gray-50md-text-sm 0 uppercase">Total Orders</h2>
                <p class="text-2xl font-semibold text-gray-800">{{ orders_count|intcomma }}</p>
            </div>
        </div>
        {# Total Products #}
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm border-l-4 border-green-500 flex items-center space-x-4">
            <div class="bg-green-100 p-3 rounded-full shadow-lg">
                <i class="fas fa-box text-green-500 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xs font-medium text-gray-500md-text-sm  uppercase">Total Products</h2>
                <p class="text-2xl font-semibold text-gray-800">{{ products_count|intcomma }}</p>
            </div>
        </div>
        {# Total Customers #}
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm border-l-4 border-purple-500 flex items-center space-x-4">
            <div class="bg-purple-100 p-3 rounded-full shadow-lg">
                <i class="fas fa-users text-purple-500 text-xl"></i>
            </div>
            <div>
                <h2 class="text-xs font-medium text-gray-500 md-text-sm uppercase">Total Customers</h2>
                <p class="text-2xl font-semibold text-gray-800">{{ customers_count|intcomma }}</p>
            </div>
        </div>
        {# Total Product Views #}
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm border-l-4 border-teal-500 flex items-center space-x-4">
            <div class="bg-teal-100 p-3 rounded-full shadow-lg">
                <i class="fas fa-eye text-teal-500 text-xl"></i> {# Eye icon for views #}
            </div>
            <div>
                <h2 class="text-xs font-medium text-gray-50md-text-sm 0 uppercase">Product Views (30d)</h2>
                <p class="text-2xl font-semibold text-gray-800">{{ total_product_views|intcomma }}</p>
            </div>
        </div>
    </section>

    <!-- Charts and Recent Activity Section -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Sales Chart (Keep as is) -->
        <div class="lg:col-span-2 bg-white p-4 md:p-6 rounded-lg shadow-sm">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Sales Overview (Last 30 Days)</h2>
            <div class="mb-4 flex flex-col sm:flex-row gap-2">
                 <input type="date" id="start_date" class="p-2 border rounded-md w-full sm:w-auto text-sm" placeholder="Start Date">
                 <input type="date" id="end_date" class="p-2 border rounded-md w-full sm:w-auto text-sm" placeholder="End Date">
                 <button id="fetchData" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md text-sm w-full sm:w-auto">
                     <i class="fas fa-filter mr-1"></i> Filter
                 </button>
            </div>
            <div class="relative h-64 md:h-80"> {# Set a height for the chart container #}
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Recent Activity Column -->
        <div class="space-y-4 md:space-y-6"> {# Container for Recent Orders and Most Viewed #}
            <!-- Recent Orders (Keep as is) -->
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Recent Orders</h2>
                <div class="space-y-4">
                    {% for order in recent_orders %}
                        <div class="flex justify-between items-center border-b border-gray-100 pb-2 last:border-b-0">
                            <div>
                                <p class="text-sm font-medium text-gray-800">Order #{{ order.id }}</p>
                                <p class="text-xs text-gray-500">{{ order.customer.name|default:"N/A" }} - {{ order.ordered_date|timesince }} ago</p>
                            </div>
                            <div class="text-right">
                                 <p class="text-sm font-semibold text-gray-800">₦{{ order.total_amount|floatformat:2|intcomma }}</p>
                                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if order.payment_made %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {% if order.payment_made %}Paid{% else %}Pending{% endif %}
                                </span>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-sm text-gray-500">No recent orders found.</p>
                    {% endfor %}
                </div>
                 <a href="{% url 'tenant:invoice_list' %}" class="mt-4 inline-block text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                    View All Orders <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>

            <!-- Most Viewed Products -->
            <div class="bg-white p-4 md:p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Most Viewed Products (30d)</h2>
                <div class="space-y-3">
                    {# Use the sliced list for the card #}
                    {% for product in most_viewed_products_card %}
                        <div class="flex justify-between items-center border-b border-gray-100 pb-2 last:border-b-0">
                            <span class="text-sm text-gray-700 truncate pr-2">{{ product.product_name|default:"(Product Removed)" }}</span>
                            <span class="text-sm font-semibold text-gray-800">{{ product.view_count|intcomma }} views</span>
                        </div>
                    {% empty %}
                        <p class="text-sm text-gray-500">No product view data available yet.</p>
                    {% endfor %}
                </div>
                <button id="viewAnalyticsBtn" class="mt-4 inline-block text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                    View Full Analytics <i class="fas fa-arrow-right ml-1"></i>
                </button>
            </div>
        </div>
    </section>

    {# --- Analytics Modal --- #}
    <div id="analyticsModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-semibold text-gray-800">Most Viewed Products (Top 15 - Last 30 Days)</h3>
                <button id="closeAnalyticsModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th scope="col" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Views</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {# Use the full list here #}
                        {% for product in most_viewed_products_full %}
                            <tr>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">{{ product.product_name|default:"(Product Removed)" }}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 text-right">{{ product.view_count|intcomma }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2" class="px-4 py-2 text-center text-sm text-gray-500">No data available.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-right">
                <button id="closeAnalyticsModalBtn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md text-sm">Close</button>
            </div>
        </div>
    </div>

</main>

{# JavaScript for Chart.js, closing alerts, and Modal #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Close Inventory Alerts (Keep as is)
    function closeInventoryAlerts() {
        const alertSection = document.getElementById('inventory-alerts');
        if (alertSection) {
            alertSection.style.display = 'none';
        }
    }

    // Sales Chart Logic (Keep as is)
    const ctx = document.getElementById('salesChart').getContext('2d');
    let salesChart; // Variable to hold the chart instance

    async function fetchChartData(startDate = '', endDate = '') {
        let url = "{% url 'tenant:orders_chart_data' %}"; // Use Django URL template tag
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);

        if (params.toString()) {
            url += `?${params.toString()}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            renderChart(data);
        } catch (error) {
            console.error("Error fetching chart data:", error);
            // Optionally display an error message to the user
        }
    }

    function renderChart(data) {
        if (salesChart) {
            salesChart.destroy(); // Destroy previous chart instance if exists
        }
        salesChart = new Chart(ctx, {
            type: 'line', // Or 'bar'
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Orders per Day',
                    data: data.orders,
                    borderColor: 'rgb(79, 70, 229)', // Indigo color
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.1,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Important for sizing within container
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            // Ensure only integers are shown on the y-axis
                            stepSize: 1,
                            callback: function(value) { if (Number.isInteger(value)) { return value; } },
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });
    }

    // Event listener for the filter button
    document.getElementById('fetchData').addEventListener('click', () => {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        fetchChartData(startDate, endDate);
    });

    // Initial chart load (last 30 days)
    document.addEventListener('DOMContentLoaded', () => {
        fetchChartData();

        // --- Modal Control Logic ---
        const viewAnalyticsBtn = document.getElementById('viewAnalyticsBtn');
        const analyticsModal = document.getElementById('analyticsModal');
        const closeAnalyticsModal = document.getElementById('closeAnalyticsModal'); // Top X button
        const closeAnalyticsModalBtn = document.getElementById('closeAnalyticsModalBtn'); // Bottom Close button

        if (viewAnalyticsBtn && analyticsModal) {
            viewAnalyticsBtn.addEventListener('click', () => {
                analyticsModal.classList.remove('hidden');
            });
        }

        if (closeAnalyticsModal && analyticsModal) {
            closeAnalyticsModal.addEventListener('click', () => {
                analyticsModal.classList.add('hidden');
            });
        }

        if (closeAnalyticsModalBtn && analyticsModal) {
            closeAnalyticsModalBtn.addEventListener('click', () => {
                analyticsModal.classList.add('hidden');
            });
        }

        // Optional: Close modal if clicking outside the modal content
        if (analyticsModal) {
            analyticsModal.addEventListener('click', (event) => {
                if (event.target === analyticsModal) { // Check if the click is on the backdrop
                    analyticsModal.classList.add('hidden');
                }
            });
        }
    });

</script>
{% endblock content %}
